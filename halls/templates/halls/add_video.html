{% extends "halls/base.html" %}

{% block content %}

<div class="container">
	<h2>Add Video to {{ hall.title }}</h2>
	
	<form method="post" id="submit_video">
		{% csrf_token %}
		{% load widget_tweaks %}

		{% for field in form %}
		<div class="form-group {% if field.errors %}alert alert-danger{% endif %}">
			{{ field.errors }}
			{{ field.label_tag }}
			{% render_field field class="form-control" %}
		</div>
		{% endfor %}
		
		

		<!--{{ form.as_p }}  
			form.as_ul form.as_table form.as_p -->
		<!-- 	same with as_p	
		{% for field in form%}
		<p>
		{{ field.errors }}
		{{ field.label_tag }}
		{{ field }}
		</p>
		{% endfor %} -->

		<BUTTON type="submit" class="btn btn-primary">Add to Hall</BUTTON>
	</form>
	<br>
	<h2>OR</h2>
	<br>
	<form method="post">
		{% csrf_token %}

		{% for field in search_form %}
		<div class="form-group">
			{{ field.errors }}
			{{ field.label_tag }}
			{% render_field field class="form-control" %}
		</div>
		{% endfor %}
	</form>

	<div id="search_results">
	<!-- we need jquery to perform ajax, and jquery has already been loaded inside the base.html -->
		<!-- Optional JavaScript -->
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity=sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

	<script type="text/javascript">
		var delayTimer;
		// id_search term is the django default form id, it's generated by django
		// keyup(function(){}) means when user type on this id's area, perform this function 
		$('#id_search_term').keyup(function() {
			clearTimeout(delayTimer);
			$('#search_results').text('Loading...');
			// make 3000 ms delay
			delayTimer = setTimeout(function() {
				var text = $('#id_search_term').val();
				// inside the function, there will be some ajax code
				$.ajax({
					url: '/video/search', // information where it is that we want to send this
					data: {
						'search_term': text
					}, // data provide for ajax to do waht???
					dataType: 'json',
					success: function(data) {

						var results = ''; // sotre the results get back from the youtube api
						$('#search_results').text(''); 
						results += '<div class="row">';
						data['items'].forEach(function(video) {
							results += '<div class="col-md-4 mt-3"><div class="card mb-4 shadow-sm">';
							results += '<iframe width="100%" height="225" src="https://www.youtube.com/embed/' + video['id']['videoId'] + '" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
							results += '<div class="card-body">';
							results += '<h5 class="card-title">' + video['snippet']['title'] + '</h5>';
							results += '<p class="card-text">' + video['snippet']['description'] + '</p>';
							results += '<p class="card-text"><strong><div class="text-left">' + video['snippet']['channelTitle'] + '</div></strong><div class="text-right text-muted">' + video['snippet']['publishedAt'].substring(0, 10) + '</div></p>';
							results += '</div><a href="#" class="btn btn-primary" onclick="addVideo(\'' + video['id']['videoId'] + '\')">Add to Hall</a>';
							results += '</div></div>';
						});
						results += '</div>';
						$('#search_results').append(results);
						//$('#search_results').text(data['Hello']); // the data's key corresponds to the output of the video_search function in the views.py
					}
				});
			}, 1000);
		});

		function addVideo(video_id) {
			$("#id_url").val('https://www.youtube.com/watch?v=' + video_id);
			$('#submit_video').submit();
		};
	</script>
	</div>

</div>


{% endblock%}